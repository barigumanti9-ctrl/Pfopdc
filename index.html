<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Aplikasi Pendataan Barang</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fa; }
    h2 { text-align: center; color: #333; }
    .header { text-align: center; margin-bottom: 20px; }
    .header img { width: 100px; }
    form { margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    label { display: block; margin: 8px 0 4px; }
    input { width: 100%; padding: 6px; margin-bottom: 10px; }
    button { margin: 4px; padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; }
    .btn-primary { background: #007bff; color: #fff; }
    .btn-danger { background: #dc3545; color: #fff; }
    .btn-success { background: #28a745; color: #fff; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; text-align: center; }
    th { background: #007bff; color: #fff; }
    tr:hover { background: #f1f1f1; }
    .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #555; }
  </style>
</head>
<body>

  <div class="header">
    <img src="logo.png" alt="Logo">
    <h2>Aplikasi Pendataan Barang</h2>
  </div>

  <form id="formBarang">
    <label>Nama Barang:</label>
    <input type="text" id="nama" required>
    <label>Merek/Type:</label>
    <input type="text" id="merek" required>
    <label>Jumlah:</label>
    <input type="number" id="jumlah" required>
    <label>Kategori:</label>
    <input type="text" id="kategori" placeholder="" required>
    <label>Keterangan:</label>
    <input type="text" id="ket">
    <button type="button" class="btn-primary" onclick="tambahBarang()">Tambah</button>
  </form>

  <div>
    <label>Filter Kategori:</label>
    <select id="filterKategori" onchange="renderTabel()">
      <option value="all">Semua</option>
    </select>
  </div>

  <table id="tabelData">
    <thead>
      <tr>
        <th>No</th>
        <th>Nama</th>
        <th>Merek</th>
        <th>Jumlah</th>
        <th>Kebutuhan Cadangan (10%)</th>
        <th>Keterangan</th>
        <th>Kategori</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div style="margin-top:10px;">
    <button class="btn-success" onclick="downloadExcel()">Download Excel</button>
    <button class="btn-success" onclick="downloadPDF()">Download PDF</button>
    <button class="btn-primary" onclick="previewPDF()">Preview PDF</button>
    <button class="btn-danger" onclick="window.print()">Cetak</button>
  </div>

  <iframe id="pdfPreview" style="width:100%; height:400px; margin-top:10px;"></iframe>

  <div class="footer">
    © Bari Gumanti
  </div>

<script>
let dataBarang = [];

function simpanData() {
  localStorage.setItem("dataBarang", JSON.stringify(dataBarang));
}

function muatData() {
  const saved = localStorage.getItem("dataBarang");
  if (saved) dataBarang = JSON.parse(saved);
  renderTabel();
  updateFilterKategori();
}

function tambahBarang() {
  const nama = document.getElementById("nama").value;
  const merek = document.getElementById("merek").value;
  const jumlah = parseInt(document.getElementById("jumlah").value);
  const ket = document.getElementById("ket").value;
  const kategori = document.getElementById("kategori").value;

  if (nama && merek && jumlah && kategori) {
    const cadangan = Math.ceil(jumlah * 0.1);
    dataBarang.push({ id: Date.now(), nama, merek, jumlah, cadangan, ket, kategori });
    renderTabel();
    updateFilterKategori();
    simpanData();
    document.getElementById("formBarang").reset();
    document.getElementById("nama").focus();
  }
}

function renderTabel() {
  const tbody = document.querySelector("#tabelData tbody");
  tbody.innerHTML = "";
  const filter = document.getElementById("filterKategori").value;
  const filtered = filter === "all" ? dataBarang : dataBarang.filter(b => b.kategori === filter);

  let totalJumlah = 0;
  let totalCadangan = 0;

  filtered.forEach((b, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${i + 1}</td>
        <td>${b.nama}</td>
        <td>${b.merek}</td>
        <td>${b.jumlah}</td>
        <td>${b.cadangan}</td>
        <td>${b.ket}</td>
        <td>${b.kategori}</td>
        <td>
          <button class="btn-primary" onclick="editBarang(${b.id})">Edit</button>
          <button class="btn-danger" onclick="hapusBarang(${b.id})">Hapus</button>
        </td>
      </tr>`;
    totalJumlah += b.jumlah;
    totalCadangan += b.cadangan;
  });

  if (filtered.length > 0) {
    tbody.innerHTML += `
      <tr style="font-weight:bold; background:#f5f5f5;">
        <td colspan="3">TOTAL</td>
        <td>${totalJumlah}</td>
        <td>${totalCadangan}</td>
        <td colspan="3"></td>
      </tr>`;
  }
}

function editBarang(id) {
  const barang = dataBarang.find(b => b.id === id);
  document.getElementById("nama").value = barang.nama;
  document.getElementById("merek").value = barang.merek;
  document.getElementById("jumlah").value = barang.jumlah;
  document.getElementById("ket").value = barang.ket;
  document.getElementById("kategori").value = barang.kategori;
  dataBarang = dataBarang.filter(b => b.id !== id);
  renderTabel();
  updateFilterKategori();
  simpanData();
}

function hapusBarang(id) {
  if (!confirm("Yakin ingin menghapus data ini?")) return;
  dataBarang = dataBarang.filter(b => b.id !== id);
  renderTabel();
  updateFilterKategori();
  simpanData();
}

function updateFilterKategori() {
  const select = document.getElementById("filterKategori");
  const kategoriUnik = [...new Set(dataBarang.map(b => b.kategori))];
  select.innerHTML = `<option value="all">Semua</option>`;
  kategoriUnik.forEach(k => {
    select.innerHTML += `<option value="${k}">${k}</option>`;
  });
}

function downloadExcel() {
  const filter = document.getElementById("filterKategori").value;
  const filtered = filter === "all" ? dataBarang : dataBarang.filter(b => b.kategori === filter);
  const judul = filter === "all" ? "Semua_Kategori" : filter;

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(filtered.map(b => ({
    Nama: b.nama, Merek: b.merek, Jumlah: b.jumlah,
    Cadangan: b.cadangan, Keterangan: b.ket, Kategori: b.kategori
  })));
  XLSX.utils.book_append_sheet(wb, ws, "Data Barang");
  XLSX.writeFile(wb, `Data_Perbaikan_${judul}.xlsx`);
}

function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const filter = document.getElementById("filterKategori").value;
  const filtered = filter === "all" ? dataBarang : dataBarang.filter(b => b.kategori === filter);
  const judul = filter === "all" ? "Semua Kategori" : filter;

  pdf.setFontSize(14);
  pdf.text(`Data Barang - ${judul}`, 14, 20);

  pdf.autoTable({
    head: [['No', 'Nama', 'Merek', 'Jumlah', 'Cadangan (10%)', 'Keterangan', 'Kategori']],
    body: filtered.map((b, i) => [i + 1, b.nama, b.merek, b.jumlah, b.cadangan, b.ket, b.kategori]),
    margin: { top: 30 },
    didDrawPage: function (data) {
      pdf.setFontSize(10);
      pdf.text("© Bari Gumanti", data.settings.margin.left, pdf.internal.pageSize.height - 10);
    }
  });

  pdf.save(`Data_Perbaikan_${judul}.pdf`);
}

function previewPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const filter = document.getElementById("filterKategori").value;
  const filtered = filter === "all" ? dataBarang : dataBarang.filter(b => b.kategori === filter);
  const judul = filter === "all" ? "Semua Kategori" : filter;

  pdf.setFontSize(14);
  pdf.text(`Data Barang - ${judul}`, 14, 20);

  pdf.autoTable({
    head: [['No', 'Nama', 'Merek', 'Jumlah', 'Cadangan (10%)', 'Keterangan', 'Kategori']],
    body: filtered.map((b, i) => [i + 1, b.nama, b.merek, b.jumlah, b.cadangan, b.ket, b.kategori]),
    margin: { top: 30 },
    didDrawPage: function (data) {
      pdf.setFontSize(10);
      pdf.text("© Bari Gumanti", data.settings.margin.left, pdf.internal.pageSize.height - 10);
    }
  });

  document.getElementById("pdfPreview").src = pdf.output('dataurlstring');
}

window.onload = muatData;
</script>

</body>
</html>